#!/bin/bash
UB_BS=512K

cp output/images/u-boot.kwb output/target/usr/lib/ubit/firmware
cp output/build/u-boot-custom/tools/env/fw_env.config  output/target/etc/
(	cd output/target
	mkdir -p proc
	mkdir -p sys
	( cd usr/lib/ubit/firmware
		for bl in *.kwb original/*.kwb; do
			dd if="$bl" bs=${UB_BS} count=1 conv=sync | md5sum > "$bl.md5"
		done
	)
	mkdir -p etc/ubit
	touch etc/ubit/ubimounts
	touch etc/ubit/extramounts
	touch etc/ubit/images
#	find . ! -iname "*.kwb" | cut -d'.' -f 2- | sort > etc/ubit/cpio_list
	find . | cut -d'.' -f 2- | sort > etc/ubit/cpio_list
	find . | sort | cpio -H newc -o | gzip > ../images/rootfs.cpio.gz
	)

ver=`cat output/target/etc/issue`

mkimage -A arm -O linux -T ramdisk -a 0x0 -e 0x0 -n "${ver}" -d output/images/rootfs.cpio.gz output/images/uInitrd 
