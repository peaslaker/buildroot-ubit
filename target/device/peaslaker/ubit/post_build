#!/bin/bash
UB_BS=512K

#cp output/images/u-boot.kwb output/target/usr/lib/ubit/firmware
cp ../u-boot/u-boot.kwb output/target/usr/lib/ubit/firmware
dd if=output/target/usr/lib/ubit/firmware/u-boot.kwb of=output/images/goflexnet.kwb bs=512K conv=sync
( 	cd output/images
	cat goflexnet.kwb | md5sum > valid.goflexnet.md5
)
cp output/build/u-boot-custom/tools/env/fw_env.config  output/target/etc/
(	cd output/target
	mkdir -p proc
	mkdir -p sys
	( cd usr/lib/ubit/firmware
		for bl in *.kwb original/*.kwb; do
			dd if="$bl" bs=${UB_BS} count=1 conv=sync | md5sum > "$bl.md5"
		done
	)
	mkdir -p etc/ubit var/run var/lock var/log dev/pts
	touch etc/ubit/ubimounts
	touch etc/ubit/extramounts
	touch etc/ubit/images
#	find . ! -iname "*.kwb" | cut -d'.' -f 2- | sort > etc/ubit/cpio_list
	find . | cut -d'.' -f 2- | sort > etc/ubit/cpio_list
cat >> etc/ubit/cpio_list <<EOF
/etc/ssh_host_key
/etc/ssh_host_rsa_key
/etc/ssh_host_dsa_key
/etc/ssh_host_key.pub
/etc/ssh_host_rsa_key.pub
/etc/ssh_host_dsa_key.pub
EOF
	find . | sort | cpio -H newc -o | gzip > ../images/rootfs.cpio.gz
	)

ver=`cat output/target/etc/issue`

mkimage -A arm -O linux -T ramdisk -a 0x0 -e 0x0 -n "${ver}" -d output/images/rootfs.cpio.gz output/images/uInitrd 
