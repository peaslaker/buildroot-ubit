#!/bin/ash
export PATH="/usr/sbin:/usr/bin:/sbin:/bin"

/bin/busybox mount -t proc proc	/proc	
/bin/busybox mount -t sysfs sys	/sys
/bin/busybox --install -s

echo "/sbin/mdev" > /proc/sys/kernel/hotplug		# mdev handles hotplug events
mkdir /dev/shm
/sbin/mdev -s		# have mdev populate /dev
ln -s /proc/mounts /etc/mtab

#	if [ ! -e /dev/md0 ]; then
#		makedevs	/dev/md		b 9 0 0 7
#		fi


echo none > /sys/class/leds/status\:orange\:misc/trigger
echo none > /sys/class/leds/status\:green\:health/trigger

mkdir /workarea /tmp

cd /workarea
cat /proc/cmdline > .cmdline
while true; do
	# returns having set a mountpoint in which we will try to boot
	echo timer > /sys/class/leds/status\:orange\:misc/trigger
	echo 100 > /sys/class/leds/status\:orange\:misc/delay_off
	echo 100 > /sys/class/leds/status\:orange\:misc/delay_on
	. /init.rootmount

	# If we have a dev directory, things are looking minimally OK, so we'll go ahead and try for the boot
	if [ "$useubi" ] && [ -d "dev" ]; then
		echo "Executing switch_root and spawning init"
		# Reset environment
		echo "" > /proc/sys/kernel/hotplug
		echo timer > /sys/class/leds/status\:orange\:misc/trigger
		echo 100 > /sys/class/leds/status\:orange\:misc/delay_off
		echo 100 > /sys/class/leds/status\:orange\:misc/delay_on
		umount /sys
		umount /proc
		mv /dev/null dev 
		mv /dev/console dev
		mv /dev/tty1 dev } && exec /bin/busybox switch_root . /sbin/init $bootargs
		exec /bin/busybox switch_root . /sbin/init $bootargs
		fi
	done

	
